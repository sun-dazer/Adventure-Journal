from django.shortcuts import render
from django.http import HttpResponse
from .mongo.main import check, make_account, delete_account, save_tip, get_tips
from django.views.decorators.csrf import csrf_exempt
import json
from django.http import JsonResponse
from .mongo.main import client

@csrf_exempt
def register(request):
    if request.method == "POST":
        try:
            # Parse JSON data from request body
            data = json.loads(request.body)
            first_name = data.get("firstName")
            last_name = data.get("lastName")
            dob = data.get("dob")
            username = data.get("username")
            password = data.get("password")
            
            # Pass all fields to make_account
            if make_account(first_name, last_name, dob, username, password):
                return JsonResponse({"msg": "Success"}, status=200)
            
            return JsonResponse({"msg": "Account already exists with that name!"}, status=400)
        
        except json.JSONDecodeError:
            return JsonResponse({"msg": "Invalid JSON format"}, status=400)


@csrf_exempt
def login(request):
    if request.method == "OPTIONS":
        # Set CORS headers for preflight request
        response = JsonResponse({})
        response["Access-Control-Allow-Origin"] = "http://localhost:3000"
        response["Access-Control-Allow-Methods"] = "POST, OPTIONS"
        response["Access-Control-Allow-Headers"] = "X-CSRFToken, Content-Type"
        return response

    if request.method == "POST":
        # Parse JSON data from request body safely
        try:
            data = json.loads(request.body)
            print("Parsed data:", data)  # Debugging
        except json.JSONDecodeError:
            print("JSON decode error")
            return JsonResponse({"msg": "Invalid JSON format"}, status=400)

        # Extract and validate username and password
        username = data.get("username")
        password = data.get("password")
        print("Username:", username)  # Debugging
        print("Password:", password)  # Debugging

        if not username or not password:
            return JsonResponse({"msg": "Username and password are required."}, status=400)

        # Attempt to check credentials
        try:
            if check(username, password):
                request.session["username"] = username
                return JsonResponse({"msg": "Success"}, status=200)
            else:
                return JsonResponse({"msg": "Username or password were incorrect!"}, status=400)
        except Exception as e:
            # Catch any unexpected errors from `check`
            print("Unexpected error in check function:", e)
            return JsonResponse({"msg": "An unexpected error occurred."}, status=500)

    return JsonResponse({"msg": "Only POST requests are allowed"}, status=405)

@csrf_exempt
def logout(request):
    if request.method == "POST":
        # Clear the session
        request.session.flush()  # Removes all session data
        return JsonResponse({"msg": "Logout successful!"}, status=200)
    return JsonResponse({"msg": "Only POST requests are allowed"}, status=405)

@csrf_exempt
def deregister(request):
    if request.method == "POST":
        if delete_account(request.POST.get("username"), request.POST.get("password")):
            request.session.flush()
            return JsonResponse({"msg": "Success"}, status=200)
        return JsonResponse({"msg": "Account credentials incorrect!"}, status=400)

@csrf_exempt
def save_tip_view(request):
    print("save_tip_view called")  # Debug
    username = request.session.get('username')
    if not username:
        return JsonResponse({"msg": "User is not logged in!"}, status=403)
    
    if request.method == "POST":
        try:
            print("Request Body:", request.body) # debug
            data = json.loads(request.body)
            #username = data.get("username")
            content = data.get("content")

            if not username or not content:
                return JsonResponse({"msg": "Username and content are required."}, status=400)

            save_tip(username, content)
            print("Tip saved successfully!")  # Debug log
            return JsonResponse({"msg": "Tip saved successfully!"}, status=200)
        except json.JSONDecodeError:
            print("Invalid JSON format")  # Debug log
            return JsonResponse({"msg": "Invalid JSON format"}, status=400)

@csrf_exempt
def get_tips_view(request):
    
        #username = request.session.get('username')
        #if not username:
        #    return JsonResponse({"msg": "User is not logged in!"}, status=403)
        collection = client.get_database("local").get_collection("tips")
        tips = list(collection.find({}, {"_id": 0}))
        #tips = get_tips()
        return JsonResponse({"tips": tips}, safe=False, status=200)

@csrf_exempt
def get_profile_view(request):
    if request.method == "GET":
        # Get the username from the session
        username = request.session.get('username')
        if not username:
            return JsonResponse({"msg": "User is not logged in!"}, status=403)
        
        # Fetch the user's profile from the database
        collection = client.get_database("local").get_collection("accounts")
        profile = collection.find_one({"username": username}, {"_id": 0, "password": 0})  # Exclude sensitive fields
        
        if not profile:
            return JsonResponse({"msg": "Profile not found!"}, status=404)
        
        # Return the profile information
        return JsonResponse({"profile": profile}, status=200)
    
    return JsonResponse({"msg": "Only GET requests are allowed"}, status=405)

@csrf_exempt
def update_profile_view(request):
    if request.method == "POST":
        try:
            username = request.session.get('username')
            if not username:
                return JsonResponse({"msg": "User is not logged in!"}, status=403)

            data = json.loads(request.body)
            first_name = data.get("first_name")
            last_name = data.get("last_name")
            bio = data.get("bio")

            collection = client.get_database("local").get_collection("accounts")
            collection.update_one(
                {"username": username},
                {"$set": {"first_name": first_name, "last_name": last_name, "bio": bio}}
            )
            return JsonResponse({"msg": "Profile updated successfully!"}, status=200)
        except Exception as e:
            return JsonResponse({"msg": f"Error updating profile: {e}"}, status=500)
    return JsonResponse({"msg": "Only POST requests are allowed"}, status=405)

@csrf_exempt
def check_login_status(request):
    username = request.session.get("username")  # Retrieve the username from the session
    if username:
        return JsonResponse({"is_logged_in": True, "username": username}, status=200)
    return JsonResponse({"is_logged_in": False}, status=200)